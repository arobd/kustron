FROM golang:alpine AS builder

# Add all the source code (except what's ignored
# under `.dockerignore`) to the build context.
ADD ./ /go/src/{{app.name}}/

RUN set -ex && \
  cd /go/src/{{app.name}} && \       
  CGO_ENABLED=0 go build \
        -tags netgo \
        -v -a \
        -ldflags '-extldflags "-static"' && \
  mv ./{{app.name}} /usr/bin/{{app.name}}

FROM alpine

# Will enable https calls from the app itself.
RUN apk add --update ca-certificates

# Retrieve the binary from the previous stage.
COPY --from=builder /usr/bin/{{app.name}} /usr/local/bin/{{app.name}}

EXPOSE {{app.port}}

# Set the binary as the entrypoint of the container.
ENTRYPOINT [ "{{app.name}}" ]